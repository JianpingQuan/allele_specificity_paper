# We map to the reference genome hg19 using bismark. The following commands are done in BASH from the terminal.
# We sample1 as an example file. The BS-seq reads where both the forward(R1) and reverse(R2) reads were kept after trimming are mapped.
# They are have the word "paired" in their filename



# Map with bismark and bowtie2. We put the outpus into a folder called sample1
# Bismark outputs a sam file
$ bismark --bowtie2 -p 4 -o sample1 /home/Shared/data/annotation/Human/GRCH37 -1 sample1_R1_t20l20_paired.fastq.gz -2 sample1_R2_t20l20_paired.fastq.gz

$ cd sample 1

# Remove duplicate reads
$ deduplicate_bismark  -p sample1_R1_paired.fastq.gz_bismark_bt2_pe.sam.gz

# Run methylation extractior. This outputs files containing methylation information on each CpG.
# We choose the --comprehensive option to collapse information of different strands into one.
$ bismark_methylation_extractor -p --comprehensive sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.sam

# Run bismark2bedGraph to get the cov files which contain the methylation counts and coverage per CpG
$ bismark2bedGraph --counts -o CpG_context_sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.bedGraph CpG_context_sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.txt

# Convert the deduplicated sam files to bam files
$ samtools view -Sb sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.sam > sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.bam
$ samtools sort sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated.bam sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated_sorted
$ samtools index sample1_R1_paired.fastq.gz_bismark_bt2_pe.deduplicated_sorted.bam





